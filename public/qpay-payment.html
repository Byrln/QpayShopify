<!DOCTYPE html>
<html lang="mn">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QPay Payment - Secure Payment Gateway</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      color: #333;
    }

    .header {
      background: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-bottom: 1px solid #e0e0e0;
    }

    .back-button {
      position: absolute;
      left: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #333;
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
    }

    .header-title {
      font-size: 18px;
      font-weight: 500;
      color: #333;
    }

    .payment-container {
      background: white;
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: calc(100vh - 60px);
    }

    .qpay-logo {
      background: #333;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      display: inline-block;
      margin: 20px 0 0 20px;
    }

    .content {
      padding: 20px;
    }

    .payment-info {
      background: white;
      padding: 0;
      margin-bottom: 20px;
    }

    .order-item {
      display: flex;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .order-icon {
      width: 40px;
      height: 40px;
      background: #007AFF;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      color: white;
      font-weight: 600;
    }

    .order-details {
      flex: 1;
    }

    .order-title {
      font-size: 16px;
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
    }

    .amount {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      text-align: right;
    }

    .qr-container {
      background: white;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }

    .qr-code {
      width: 280px;
      height: 280px;
      margin: 20px auto;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      font-size: 14px;
      color: #666;
    }

    .qr-instructions {
      color: #333;
      font-size: 14px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .qr-note {
      color: #666;
      font-size: 13px;
      line-height: 1.4;
      margin-top: 15px;
    }

    .status {
      padding: 16px 20px;
      font-weight: 500;
      font-size: 14px;
      background: white;
      margin: 0;
      border-top: 1px solid #e0e0e0;
    }

    .status.waiting {
      background: white;
      color: #666;
    }

    .status.success {
      background: #4CAF50;
      color: white;
    }

    .status.error {
      background: #f44336;
      color: white;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #666;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .timer {
      display: none;
    }

    .payment-button {
      background: #333;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 600;
      margin: 20px;
      width: calc(100% - 40px);
      cursor: pointer;
    }

    .bank-buttons {
      background: #f5f5f5;
      padding: 20px;
      margin: 0;
      display: none; /* Hidden on desktop */
    }

    /* Show bank buttons only on mobile and tablets */
    @media (max-width: 1023px) {
      .bank-buttons {
        display: block;
      }
    }

    .bank-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      max-width: 100%;
      margin: 0;
    }

    .bank-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px 12px;
      background: white;
      border: none;
      border-radius: 16px;
      text-decoration: none;
      color: #333;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      min-height: 100px;
      position: relative;
    }

    .bank-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .bank-button:active {
      transform: translateY(0);
    }

    .bank-button img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      margin-bottom: 8px;
      border-radius: 8px;
    }

    .bank-button span {
      font-size: 12px;
      font-weight: 500;
      text-align: center;
      line-height: 1.2;
      color: #333;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    /* Responsive Design */
    @media (min-width: 480px) {
      .bank-grid {
        gap: 20px;
      }
      
      .bank-button {
        padding: 24px 16px;
        min-height: 110px;
      }
      
      .bank-button img {
        width: 52px;
        height: 52px;
      }
      
      .bank-button span {
        font-size: 13px;
      }
    }

    @media (min-width: 768px) {
      body {
        background: #f0f0f0;
      }
      
      .payment-container {
        max-width: 480px;
        margin: 20px auto;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      
      .header {
        border-radius: 16px 16px 0 0;
      }
      
      .bank-grid {
        gap: 24px;
        padding: 0 20px;
      }
      
      .bank-button {
        padding: 28px 20px;
        min-height: 120px;
      }
      
      .bank-button img {
        width: 56px;
        height: 56px;
        margin-bottom: 10px;
      }
      
      .bank-button span {
        font-size: 14px;
      }
      
      .qr-code {
        width: 320px;
        height: 320px;
      }
    }

    @media (min-width: 1024px) {
      .payment-container {
        max-width: 600px;
      }
      
      .content {
        padding: 30px;
      }
      
      .qr-container {
        padding: 30px;
      }
      
      .bank-buttons {
        padding: 30px;
      }
      
      .bank-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 28px;
        max-width: 500px;
        margin: 0 auto;
      }
      
      .bank-button {
        padding: 32px 24px;
        min-height: 130px;
      }
      
      .bank-button img {
        width: 60px;
        height: 60px;
        margin-bottom: 12px;
      }
      
      .bank-button span {
        font-size: 15px;
      }
      
      .qr-code {
        width: 360px;
        height: 360px;
      }
    }

    @media (max-width: 360px) {
      .header {
        padding: 10px 12px;
      }
      
      .header-title {
        font-size: 16px;
      }
      
      .back-button {
        width: 28px;
        height: 28px;
        font-size: 16px;
      }
      
      .content {
        padding: 16px;
      }
      
      .qr-container {
        padding: 16px;
      }
      
      .bank-buttons {
        padding: 16px;
      }
      
      .bank-grid {
        gap: 12px;
      }
      
      .bank-button {
        padding: 16px 8px;
        min-height: 85px;
      }
      
      .bank-button img {
        width: 40px;
        height: 40px;
        margin-bottom: 6px;
      }
      
      .bank-button span {
        font-size: 11px;
        line-height: 1.1;
      }
      
      .qr-code {
        width: 240px;
        height: 240px;
      }
      
      .payment-button {
        margin: 16px;
        width: calc(100% - 32px);
        padding: 14px 24px;
        font-size: 15px;
      }
    }

  </style>
</head>

<body>
  <div class="header">
    <button class="back-button" onclick="history.back()">‹</button>
    <div class="header-title">Зээл сунгах</div>
  </div>
  
  <div class="payment-container">
    <div class="qpay-logo">QPay</div>
    
    <div class="content">
      <div class="payment-info">
        <div class="order-item">
          <div class="order-icon">₮</div>
          <div class="order-details">
            <div class="order-title">Төлөх дүн</div>
          </div>
          <div class="amount" id="amount">₮0</div>
        </div>
      </div>
    </div>

    <div class="timer" id="timer">
      ⏰ Төлбөрийн хугацаа дуусах хугацаа: <span id="countdown">15:00</span>
    </div>
    
    <div class="qr-container">
      <div class="qr-code" id="qrCode">
        <div class="loading"></div>
        QR код үүсгэж байна...
      </div>
      <div class="qr-note">QPay-ээр төлбөр хийхэд 100₮ -ийн шимтгэлтэйг анхаараарай.</div>
      <button class="payment-button">Төлбөр шалгах</button>
    </div>

    <div class="bank-buttons" id="bankButtons" style="display: none;">
      <div class="bank-grid" id="bankGrid">
        <!-- Bank buttons will be populated here -->
      </div>
    </div>

    <div class="status waiting" id="status">
      <div class="loading"></div>
      Төлбөрийн баталгаажуулалтыг хүлээж байна...
    </div>

  </div>

  <script>
    // Get order details from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId') || 'DEMO-12345';
    const amount = parseFloat(urlParams.get('amount')) || 99.99;
    const currency = urlParams.get('currency') || 'USD';
    const orderNumber = urlParams.get('orderNumber') || '#1001';
    const itemCount = urlParams.get('items') || '3 items';

    // Display order info
    document.getElementById('amount').textContent =
      currency === 'MNT' ? '₮' + amount.toLocaleString() : '$' + amount.toFixed(2);

    // Timer countdown
    let timeLeft = 15 * 60; // 15 minutes in seconds

    function updateTimer() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      document.getElementById('countdown').textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

      if (timeLeft <= 0) {
        document.getElementById('status').className = 'status error';
        document.getElementById('status').innerHTML = '❌ Төлбөрийн хугацаа дууссан. Дахин оролдоно уу.';
        return;
      }

      timeLeft--;
      setTimeout(updateTimer, 1000);
    }

    // Bank names are now provided directly from the API response

    // Display bank buttons with deep links from QPay API
     function displayBankButtons(deepLinks) {
      // Check if we're on desktop (screen width > 1023px)
      if (window.innerWidth > 1023) {
        // Don't create bank buttons on desktop to avoid image loading errors
        return;
      }
      
      const bankButtons = document.getElementById('bankButtons');
      const bankGrid = document.getElementById('bankGrid');

      // Clear existing buttons
      bankGrid.innerHTML = '';

      // Create buttons for each deep link from QPay API response
       if (deepLinks && deepLinks.length > 0) {
         deepLinks.forEach(deepLink => {
          const button = document.createElement('a');
           button.className = 'bank-button';
           button.href = deepLink.link || '#';
           button.target = '_blank';
           button.rel = 'noopener noreferrer';

           // Create bank logo image
            const img = document.createElement('img');
            const bankName = deepLink.name || 'bank';
            const bankCode = bankName.toLowerCase().replace(/\s+/g, '');
            img.src = deepLink.logo || `https://qpay.mn/q/logo/${bankCode}.png`;
            img.alt = bankName;
            img.onerror = function () {
              // Fallback to a generic bank icon if logo fails to load
              this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjQ4IiByeD0iOCIgZmlsbD0iIzM3NDE1MSIvPgo8cGF0aCBkPSJNMTIgMjBIMzZWMzJIMTJWMjBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTYgMTZIMzJWMjBIMTZWMTZaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K';
            };
            button.appendChild(img);

           // Create bank name span with Mongolian name from API
           const span = document.createElement('span');
           span.textContent = deepLink.description || deepLink.name || 'Банк';

          button.appendChild(span);
          bankGrid.appendChild(button);
        });
      }

      // Show the bank buttons section
      bankButtons.style.display = 'block';
    }

    // Create QPay invoice
    async function createInvoice() {
      try {
        const response = await fetch('/api/qpay/invoice', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            orderId: orderId,
            amount: amount,
            currency: currency,
            orderNumber: orderNumber
          })
        });

        const result = await response.json();

        if (result.success) {
          // Store invoice ID for status checking
          window.currentInvoiceId = result.data.invoice_id;

          // Generate QR code from qr_text since QPay's qr_image field contains raw text data
          if (result.data.qr_text) {
            fetch(`/api/qr/generate?data=${encodeURIComponent(result.data.qr_text)}`)
              .then(response => response.json())
              .then(qrResult => {
                if (qrResult.success && qrResult.dataUrl) {
                  document.getElementById('qrCode').innerHTML =
                    `<img src="${qrResult.dataUrl}" alt="QPay QR Code" style="width: 100%; height: 100%; object-fit: contain;">`;
                }
              })
              .catch(error => {
                console.error('QR generation error:', error);
                document.getElementById('qrCode').innerHTML = '<div>QR код алдаа</div>';
              });
          } else {
            document.getElementById('qrCode').innerHTML = '<div>QR код алдаа</div>';
          }

          // Display bank buttons if qPay_deeplink are available from QPay API (only on mobile/tablet)
          if (window.innerWidth <= 1023) {
            if (result.data.qPay_deeplink && result.data.qPay_deeplink.length > 0) {
              displayBankButtons(result.data.qPay_deeplink);
            } else if (result.data.urls && result.data.urls.length > 0) {
              // Fallback for backward compatibility
              displayBankButtons(result.data.urls);
            }
          }

          // Start checking payment status
          checkPaymentStatus(orderId);

          // Start timer
          updateTimer();
        } else {
          throw new Error(result.error || 'Failed to create invoice');
        }
      } catch (error) {
        console.error('Invoice creation error:', error);
        document.getElementById('status').className = 'status error';
        document.getElementById('status').innerHTML = '❌ Төлбөр үүсгэхэд алдаа гарлаа: ' + error.message;

        // Show demo QR code for testing
        document.getElementById('qrCode').innerHTML =
          '<div style="background: #f0f0f0; padding: 20px; border-radius: 8px;">Жишээ QR код<br><small>Сервер боломжгүй</small></div>';
      }
    }

    // Check payment status
    async function checkPaymentStatus(orderId) {
      const checkStatus = async () => {
        try {
          // Use the invoice ID from the created invoice to check status
          if (!window.currentInvoiceId) {
            console.error('No invoice ID available for status check');
            return;
          }
          const response = await fetch(`/api/qpay/invoice/${window.currentInvoiceId}`);
          const result = await response.json();

          if (result.success && result.data.status === 'PAID') {
            document.getElementById('status').className = 'status success';
            document.getElementById('status').innerHTML =
              '✅ Төлбөр амжилттай! Баталгаажуулах хуудас руу шилжүүлж байна...';

            // Redirect to success page after 3 seconds
            setTimeout(() => {
              window.location.href = `/payment-success.html?orderId=${orderId}&amount=${amount}`;
            }, 3000);
            return;
          }
        } catch (error) {
          console.error('Status check error:', error);
        }

        // Check again in 3 seconds if payment not completed
        if (timeLeft > 0) {
          setTimeout(checkStatus, 3000);
        }
      };

      // Start checking after 2 seconds
      setTimeout(checkStatus, 2000);
    }

    // Initialize the payment process
    createInvoice();

    // Handle page visibility change (pause/resume timer when tab is hidden/visible)
    document.addEventListener('visibilitychange', function () {
      if (document.hidden) {
        // Page is hidden, you might want to pause the timer
      } else {
        // Page is visible, resume normal operation
        // You could also refresh the payment status here
      }
    });
  </script>
</body>

</html>